/*!Sun Dec 15 2013 23:43:01 */
window.Puls3={},Puls3.Views={},Puls3.Collections={},Puls3.Models={},Puls3.Routers={},window.app={},window.routers={},window.plugs={},window.views={},window.collections={},Puls3.Models.ArticleModel=Backbone.Model.extend({urlRoot:"/articles",defaults:{},prettyDate:function(a){if(!a||"0000-00-00 00:00:00"===a)return"";var a=Date.parse(a);return a.toString("MMMM dd, yyyy")},parse:function(a){return a.data?a.data:a}}),Puls3.Models.Article=Puls3.Models.ArticleModel,Puls3.Collections.ArticlesCollection=Backbone.Collection.extend({model:Puls3.Models.ArticleModel,url:"",name:"articles",search:function(a){if(""==a)return this;var b=new RegExp(a,"gi");return _(this.filter(function(a){return b.test(a.get("name"))}))},comparator:function(a){return a.get("name")},getOne:function(a){return this.filter(function(b){return b.get("id")==a})},parse:function(a){return a.data}}),Puls3.Collections.articles=Puls3.Collections.ArticlesCollection,Puls3.Routers.BaseRouter=Backbone.Router.extend({routes:{"":"root","article/:id":"articleSingle"},initialize:function(){},root:function(){window.app.state="root"},articleSingle:function(a){window.app.state="articleSingle",window.app.article=a}}),Puls3.Views.ArticleView=Backbone.View.extend({events:{"click > article":"navigate","click .likes_up":"upvote","click .likes_down":"downvote"},className:"",initialize:function(a){var b=this;this.model=a,this.model.on("change",function(){b.render()}),window.routers.on("route:root",function(){b.render()}),window.routers.on("route:articleSingle",function(){b.render()}),this.template=swig.compile($("#Article_tpl").html()),this.templateExtended=swig.compile($("#ArticleExtended_tpl").html())},navigate:function(){return Backbone.history.navigate("article/"+this.model.get("id"),{trigger:!0}),null},upvote:function(a){a.stopPropagation();var b=this.model.get("votes");return this.model.set("votes",parseInt(b,10)+1),this.model.save(),null},downvote:function(a){a.stopPropagation();var b=this.model.get("votes");return this.model.set("votes",parseInt(b,10)-1),this.model.save(),null},render:function(){var a={post:this.model.toJSON()};return"articleSingle"===window.app.state?window.app.article===this.model.get("id")?(this.$el.show(),this.$el.html(this.template(a))):(console.log("No hay datos"),this.$el.html(""),this.$el.hide()):this.$el.html(this.template(a)),this}}),Puls3.Views.ArticleNewView=Backbone.View.extend({events:{"click button":"create"},className:"",initialize:function(a){this.$el=a},create:function(){console.log("Boton Clickeado");var a=this.$el.find("#title").val(),b=this.$el.find("#tag").val(),c=this.$el.find("#content").val(),d=new Puls3.Models.Article({title:a,tag:b,content:c}),e=d.save();e.done(function(a){console.log(a)})},render:function(){}}),$(document).ready(function(){console.log("Starting app"),window.ponyExpress=new PonyExpress({io:"http://192.168.0.20:3000"}),window.collections.articles=new Puls3.Collections.ArticlesCollection,window.ponyExpress.bind("connect",function(){window.plugs.article=new PonyExpress.BackbonePlug({collection:window.collections.articles})}),window.views.articleNew=new Puls3.Views.ArticleNewView($("#contenido > aside")),window.collections.articles.on("add",function(a){var b=new Puls3.Views.ArticleView(a);b.render(),b.$el.appendTo("#contenido")}),window.routers=new Puls3.Routers.BaseRouter;var a=$.get("/articles/all");a.done(function(a){console.log(a),a.forEach(function(a){window.collections.articles.add(a)}),Backbone.history.start({root:"/",pushState:!0,silent:!1})}),$("nav li:first").on("click",function(){Backbone.history.navigate("",{trigger:!0})})});